{% extends "dashboard/base_dashboard.html" %} {% from
"components/product_card.html" import product_card %} {% block title %}Tienda -
Wawalu{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Header & Actions -->
  <div
    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8"
  >
    <div>
      <h1 class="text-2xl font-bold text-gray-800">Tienda Escolar</h1>
      <p class="text-gray-500">Uniformes, útiles y materiales educativos</p>
    </div>

    <div class="flex gap-3">
      <a
        href="{{ url_for('cart') }}"
        class="bg-white text-gray-700 px-4 py-2 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors flex items-center shadow-sm relative"
      >
        <span class="material-symbols-outlined mr-2">shopping_cart</span>
        Carrito {% if session.get('cart') %}
        <span
          class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full"
        >
          {{ session.get('cart') | length }}
        </span>
        {% endif %}
      </a>

      {% if session.get('user_role') in ['staff', 'admin'] %}
      <button
        onclick="openAddProductModal()"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center shadow-sm"
      >
        <span class="material-symbols-outlined mr-2">add</span>
        Nuevo Producto
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Products Grid -->
  {% if products %}
  <div
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
  >
    {% for product in products %} {{ product_card(product,
    show_delete=session.get('user_role') in ['staff', 'admin']) }} {% endfor %}
  </div>
  {% else %}
  <div
    class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-200"
  >
    <span class="material-symbols-outlined text-6xl text-gray-300 mb-4"
      >storefront</span
    >
    <h3 class="text-xl font-medium text-gray-500">
      No hay productos disponibles
    </h3>
    <p class="text-gray-400 mt-2">Vuelve pronto para ver las novedades.</p>
  </div>
  {% endif %}
</div>

<!-- Product Detail Modal -->
<div
  id="productModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm"
>
  <div
    class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full overflow-hidden animate-scale-in flex flex-col md:flex-row max-h-[90vh]"
  >
    <!-- Modal Image -->
    <div class="w-full md:w-1/2 bg-gray-100 relative h-64 md:h-auto">
      <img
        id="modalImage"
        src=""
        alt="Product"
        class="w-full h-full object-cover"
      />
      <button
        onclick="closeProductModal()"
        class="absolute top-4 left-4 bg-white/80 p-2 rounded-full md:hidden"
      >
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="w-full md:w-1/2 p-6 md:p-8 overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <div>
          <span
            id="modalCategory"
            class="text-xs font-bold uppercase tracking-wider text-blue-600 bg-blue-50 px-2 py-0.5 rounded"
            >Category</span
          >
          <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mt-2">
            Product Name
          </h2>
        </div>
        <button
          onclick="closeProductModal()"
          class="text-gray-400 hover:text-gray-600 hidden md:block"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <p id="modalPrice" class="text-3xl font-bold text-gray-900 mb-6">
        S/ 0.00
      </p>

      <div class="space-y-6 mb-8">
        <div>
          <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">
            Descripción
          </h3>
          <p id="modalDescription" class="text-gray-600 leading-relaxed">
            Description goes here.
          </p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">
              Material
            </h3>
            <p id="modalMaterial" class="text-gray-600 text-sm">
              Material info
            </p>
          </div>
          <div>
            <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">
              Uso Recomendado
            </h3>
            <p id="modalUsage" class="text-gray-600 text-sm">Usage info</p>
          </div>
        </div>

        <div id="modalDimensionsContainer">
          <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">
            Dimensiones
          </h3>
          <p id="modalDimensions" class="text-gray-600 text-sm">
            Dimensions info
          </p>
        </div>

        <div id="modalSizesContainer">
          <h3 class="text-sm font-bold text-gray-900 uppercase mb-2">
            Tallas Disponibles
          </h3>
          <div id="modalSizes" class="flex flex-wrap gap-2">
            <!-- Sizes injected via JS -->
          </div>
        </div>
      </div>

      <form
        id="modalForm"
        action=""
        method="POST"
        class="pt-6 border-t border-gray-100"
      >
        <div class="flex gap-4">
          <div
            class="flex items-center border border-gray-300 rounded-xl bg-gray-50 h-12"
          >
            <button
              type="button"
              onclick="decrementQty(this)"
              class="px-3 text-gray-600 hover:bg-gray-200 h-full rounded-l-xl"
            >
              -
            </button>
            <input
              type="number"
              name="quantity"
              value="1"
              min="1"
              id="modalQty"
              class="w-12 text-center bg-transparent border-none p-0 font-bold focus:ring-0"
              readonly
            />
            <button
              type="button"
              onclick="incrementQty(this)"
              id="modalIncBtn"
              class="px-3 text-gray-600 hover:bg-gray-200 h-full rounded-r-xl"
            >
              +
            </button>
          </div>
          <button
            type="submit"
            class="flex-1 bg-blue-600 text-white h-12 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined">shopping_cart</span>
            Agregar al Carrito
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Product Modal (Admin) -->
<div
  id="addProductModal"
  class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden items-center justify-center p-4"
>
  <div
    class="bg-white rounded-2xl shadow-xl max-w-md w-full overflow-hidden animate-fade-in"
  >
    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
      <h3 class="text-lg font-bold text-gray-800">Nuevo Producto</h3>
      <button
        onclick="closeAddProductModal()"
        class="text-gray-400 hover:text-gray-600"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <form
      action="{{ url_for('add_product') }}"
      method="POST"
      enctype="multipart/form-data"
      class="p-6 space-y-4"
    >
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Nombre</label
        >
        <input
          type="text"
          name="name"
          required
          class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Precio (S/)</label
        >
        <input
          type="number"
          step="0.01"
          name="price"
          required
          class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
        />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Categoría</label
        >
        <select
          name="category"
          class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
        >
          <option value="Uniformes">Uniformes</option>
          <option value="Útiles">Útiles</option>
          <option value="Libros">Libros</option>
          <option value="Accesorios">Accesorios</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Descripción</label
        >
        <textarea
          name="description"
          rows="2"
          class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"
        ></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Imagen</label
        >
        <input
          type="file"
          name="image"
          accept="image/*"
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
      </div>

      <div class="pt-4">
        <button
          type="submit"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30"
        >
          Guardar Producto
        </button>
      </div>
    </form>
  </div>
</div>

<script src="{{ url_for('static', filename='js/shop_dashboard.js') }}"></script>
<script>
  // Pass Flask URLs to the modal elements
  document.addEventListener('DOMContentLoaded', function() {
    const modalImage = document.getElementById('modalImage');
    const modalForm = document.getElementById('modalForm');
    if (modalImage) {
      modalImage.dataset.baseUrl = "{{ url_for('serve_image', table='products', id=0) }}".replace("/0", "");
      modalImage.dataset.defaultImage = "{{ url_for('static', filename='image/default_product.png') }}";
    }
    if (modalForm) {
      modalForm.dataset.cartBaseUrl = "{{ url_for('add_to_cart', product_id=0) }}";
    }
  });
</script>
{% endblock %}
