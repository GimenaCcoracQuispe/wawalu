{% extends "base.html" %} {% block title %}Detalle del Pedido #{{ order.id }} -
PG Wawalu{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-8">
    <a
      href="{{ url_for('orders') }}"
      class="text-gray-500 hover:text-blue-600 flex items-center transition-colors mb-4"
    >
      <i class="fas fa-arrow-left mr-2"></i> Volver a Mis Pedidos
    </a>
    <div
      class="flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <div>
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
          Pedido #{{ order.id }} {% if order.status == 'pending' %}
          <span
            class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800"
            >Pendiente</span
          >
          {% elif order.status == 'paid' %}
          <span
            class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"
            >Pagado</span
          >
          {% elif order.status == 'shipped' %}
          <span
            class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800"
            >Enviado</span
          >
          {% elif order.status == 'completed' %}
          <span
            class="px-3 py-1 text-sm font-semibold rounded-full bg-gray-100 text-gray-800"
            >Completado</span
          >
          {% elif order.status == 'cancelled' %}
          <span
            class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800"
            >Cancelado</span
          >
          {% endif %}
        </h1>
        <p class="text-gray-500 mt-1">
          Realizado el {{ order.created_at.strftime('%d de %B, %Y a las %H:%M')
          }}
        </p>
      </div>
      <!-- Optional: Add action buttons like "Download Invoice" or "Support" here -->
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column: Order Items -->
    <div class="lg:col-span-2 space-y-6">
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"
      >
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
          <h3 class="text-lg font-semibold text-gray-800">Productos</h3>
        </div>
        <div class="divide-y divide-gray-100">
          {% for item in order_items %}
          <div class="p-6 flex items-center">
            <!-- Placeholder for product image if available -->
            <div
              class="w-16 h-16 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center text-gray-400 mr-4"
            >
              <i class="fas fa-image text-xl"></i>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-gray-900">{{ item.name }}</h4>
              <p class="text-sm text-gray-500">Cantidad: {{ item.quantity }}</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-gray-900">
                S/ {{ "%.2f"|format(item.subtotal) }}
              </p>
              <p class="text-xs text-gray-500">
                S/ {{ "%.2f"|format(item.price_at_purchase) }} c/u
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Payment Instructions (if pending) -->
      {% if order.status == 'pending' %}
      <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
        <h3 class="text-lg font-semibold text-blue-800 mb-2">
          Instrucciones de Pago
        </h3>
        {% if order.payment_method == 'yape' %}
        <p class="text-blue-700 mb-2">
          Elegiste pagar con <strong>Yape</strong>.
        </p>
        <ul class="list-disc list-inside text-blue-600 text-sm space-y-1">
          <li>Envía el pago al número <strong>+51942139788</strong></li>
          <li>
            Monto a pagar:
            <strong>S/ {{ "%.2f"|format(order.total_amount) }}</strong>
          </li>
          <li>
            Envía la captura de pantalla a nuestro WhatsApp indicando tu número
            de pedido (#{{ order.id }}).
          </li>
        </ul>
        {% elif order.payment_method == 'transfer' %}
        <p class="text-blue-700 mb-2">
          Elegiste pagar con <strong>Transferencia Bancaria</strong>.
        </p>
        <ul class="list-disc list-inside text-blue-600 text-sm space-y-1">
          <li>Realiza la transferencia a nuestras cuentas BCP o Interbank.</li>
          <li>
            Usa la referencia
            <strong>WAWALU-{{ session.get('user_id') }}</strong>.
          </li>
          <li>Envía el comprobante a nuestro correo o WhatsApp.</li>
        </ul>
        {% elif order.payment_method == 'cash' %}
        <p class="text-blue-700 mb-2">
          Elegiste <strong>Pago en Efectivo</strong>.
        </p>
        <p class="text-blue-600 text-sm">
          Acércate a nuestra sede o agente autorizado con el código
          <strong>CASH-{{ session.get('user_id') }}</strong> para realizar el
          pago.
        </p>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Right Column: Order Summary & Info -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Summary -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumen</h3>
        <div class="space-y-3">
          <div class="flex justify-between text-gray-600">
            <span>Subtotal</span>
            <span>S/ {{ "%.2f"|format(order.total_amount - 15) }}</span>
          </div>
          <div class="flex justify-between text-gray-600">
            <span>Envío</span>
            <span>S/ 15.00</span>
          </div>
          <div
            class="pt-3 border-t border-gray-100 flex justify-between text-lg font-bold text-gray-900"
          >
            <span>Total</span>
            <span>S/ {{ "%.2f"|format(order.total_amount) }}</span>
          </div>
        </div>
      </div>

      <!-- Shipping Info -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Datos de Envío</h3>
        <div class="space-y-3 text-sm">
          <div>
            <p class="text-gray-500 text-xs uppercase tracking-wide">
              Destinatario
            </p>
            <p class="font-medium text-gray-900">
              {{ order.shipping_name }} {{ order.shipping_lastname }}
            </p>
          </div>
          <div>
            <p class="text-gray-500 text-xs uppercase tracking-wide">
              Dirección
            </p>
            <p class="text-gray-900">{{ order.shipping_address }}</p>
          </div>
          <div>
            <p class="text-gray-500 text-xs uppercase tracking-wide">
              Contacto
            </p>
            <p class="text-gray-900">{{ order.shipping_phone }}</p>
            <p class="text-gray-900">{{ order.shipping_email }}</p>
          </div>
        </div>
      </div>

      <!-- Payment Info -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Método de Pago</h3>
        <div class="flex items-center mb-4">
          <div
            class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 mr-3"
          >
            {% if order.payment_method == 'yape' %}
            <span class="material-symbols-outlined">qr_code_scanner</span>
            {% elif order.payment_method == 'transfer' %}
            <span class="material-symbols-outlined">account_balance</span>
            {% else %}
            <span class="material-symbols-outlined">payments</span>
            {% endif %}
          </div>
          <div>
            <p class="font-medium text-gray-900 capitalize">
              {{ order.payment_method }}
            </p>
            <p class="text-xs text-gray-500">
              {% if order.status == 'paid' %}Pagado{% else %}Pendiente de pago{%
              endif %}
            </p>
          </div>
        </div>

        <!-- Payment Proof Display -->
        {% if order.payment_proof_type %}
        <div class="mt-4 pt-4 border-t border-gray-100">
          <p class="text-sm font-medium text-gray-700 mb-2">
            Comprobante de Pago
          </p>
          {% if 'image' in order.payment_proof_type %}
          <div
            class="relative group cursor-pointer"
            onclick="window.open('{{ url_for('serve_image', table='orders', id=order.id) }}', '_blank')"
          >
            <img
              src="{{ url_for('serve_image', table='orders', id=order.id) }}"
              alt="Comprobante"
              class="w-full h-48 object-cover rounded-lg border border-gray-200 hover:opacity-90 transition-opacity"
            />
            <div
              class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
            >
              <span
                class="bg-black/50 text-white px-3 py-1 rounded-full text-xs backdrop-blur-sm"
              >
                Clic para ampliar
              </span>
            </div>
          </div>
          {% else %}
          <a
            href="{{ url_for('serve_image', table='orders', id=order.id) }}"
            target="_blank"
            class="flex items-center p-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors"
          >
            <span class="material-symbols-outlined mr-2">description</span>
            <span class="text-sm font-medium">Ver Documento (PDF)</span>
          </a>
          {% endif %}
        </div>
        {% endif %}

        <!-- Admin Actions -->
        {% if session.get('user_role') in ['admin', 'staff'] and order.status ==
        'pending' %}
        <div class="mt-6 pt-4 border-t border-gray-100">
          <button
            onclick="updateOrderStatus('{{ order.id }}', 'paid')"
            class="w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
          >
            <span class="material-symbols-outlined text-sm">check_circle</span>
            Aprobar Pago
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/order_detail.js') }}"></script>
